name: Update Ticker Master

on:
  schedule:
    # 毎週日曜日の日本時間 0:00 に実行（UTC 15:00、日曜日）
    - cron: '0 15 * * 0'
  workflow_dispatch:  # 手動実行も可能にする

jobs:
  update-master:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # コミット・プッシュに必要
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create data directories
        run: |
          mkdir -p data/raw
          mkdir -p scripts
      
      - name: Update ticker master
        run: |
          python3 scripts/update_ticker_master.py
        continue-on-error: false
      
      - name: Commit and push changes
        run: |
          # Git設定
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 最新の変更を取得
          echo "=== Pulling latest changes with rebase ==="
          git pull --rebase origin main || {
            echo "Rebase failed, trying regular pull..."
            git pull origin main || echo "Pull failed, continuing anyway"
          }
          
          # ステージング: jpx_tse_info.csvを追加
          echo "=== Staging files ==="
          git add data/raw/jpx_tse_info.csv || echo "No jpx_tse_info.csv to add"
          
          # ステージングされたファイルを確認
          echo "=== Staged files ==="
          git diff --cached --name-only || echo "No staged files"
          
          # 変更がある場合のみコミット
          if ! git diff --cached --exit-code --quiet; then
            echo "=== Changes detected, committing ==="
            git status
            echo ""
            git commit -m "Auto-update ticker master: $(date +'%Y-%m-%d %H:%M:%S')"
            
            # プッシュ前に再度最新の変更を取得
            echo "=== Pulling latest changes before push ==="
            git pull --rebase origin main || {
              echo "Rebase failed before push, trying regular pull..."
              git pull origin main || echo "Pull failed, continuing anyway"
            }
            
            # プッシュを実行（失敗時は再試行）
            echo "=== Pushing to repository ==="
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin main; then
                echo "Push successful!"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "Push failed, attempt $RETRY_COUNT/$MAX_RETRIES"
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Pulling latest changes and retrying..."
                  git pull --rebase origin main || git pull origin main || true
                  sleep 2
                else
                  echo "Push failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "=== No changes to commit ==="
            git status
          fi
